<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <meta content="email=no" name="format-detection">
    <title>体验官招募</title>
    <link href="resources/css/reset.css?v=18" type="text/css" rel="stylesheet" />
    <link href="resources/css/main.css?v=18" type="text/css" rel="stylesheet" />
	<script src="resources/js/jquery-2.1.1.min.js" type="application/javascript" language="javascript"></script>
    <script src="resources/js/gVerify.js?v=18" type="application/javascript" language="javascript"></script>
    <script src="resources/js/md5.min.js" type="application/javascript" language="javascript"></script>
    <script src="resources/js/common.js?v=18" type="application/javascript" language="javascript"></script>
</head>

<body>
    <div class="banner" id="banner1"><img src="resources/images/banner1.jpg?v=18"> </div>
    <div class="banner dpn" id="banner2"><img src="resources/images/banner2.jpg?v=18"> </div>

    <!-- 错误提示-->
    <div class="warn" id="warn"><span>首期仅支持云服务唐车主参加哦</span></div>

    <!-- 第一屏-->
    <div class="w80 mat mt8 " id="frame1">
        <div class="input-line">
            <span class="name">手机号</span>
            <input type="tel" placeholder="请输入云服务手机号" id="phone" maxlength="11" autocomplete="off">
        </div>
        <div class="input-line">
            <span class="name">验证码</span>
            <input type="text" placeholder="请输入图形验证码" id="imgCodeVal" maxlength="4" autocomplete="off">
            <div class="img"><canvas width="100" height="30" id="imgCode"></canvas></div>
        </div>
        <div class="img"><canvas width="100" height="30" id="imgCode1"></canvas></div>
        <div class="img"><canvas width="200" height="60" id="imgCode2"></canvas></div>
        <a href="javascript:;" class="btn mt8 mb15" id="btn1">提交</a>
        <div class="intro">
            <h3>申请条件</h3>
            <p>已注册云服务的宋车主（宋、宋EV、宋DM、宋MAX）</p>
        </div>
        <div class="intro">
            <h3>报名时间</h3>
            <p>2018.09.04-2018.09.06（招满即止）</p>
        </div>
        <div class="intro">
            <h3>客服热线</h3>
            <p>400-830-3666转2号</p>
        </div>
        <div class="intro">
            <p>* 其他车型陆续开放中，敬请期待！</p>
        </div>
    </div>
    <!-- 第二屏-->
    <div class="w80 mat mt10 dpn"  id="frame2">
        <p class="title">短信发送至</p>
        <div class="phone" id="phone2">158 3920 9210</div>
        <div class="pr ovh">
            <ul class="code-list" id="codeList">
                <li></li>
                <li></li>
                <li></li>
                <li></li>
                <li></li>
                <li></li>
            </ul>
            <input type="text" class="code-input" id="codeInput" maxlength="6" autocomplete="off">
        </div>
        <div class="count" id="count">
            <span>60s后获取</span>
        </div>
        <a href="javascript:;" class="btn mt8 mb15" id="btn2">完成</a>
    </div>
    <!--第三屏-->
    <div class="w80 mat dpn" id="frame3">
        <div class="qrcode">
            <!--<img src="resources/images/hint.png">-->
            <a href="javascript:;" id="btnQrcode"><img src="resources/images/qrcode.jpg"></a>
        </div>
        <div class="intro intro2">
            <h3>关注公众号方式</h3>
            <p>1. 截取当前屏幕，保存到本地相册。</p>
            <p>2. 微信打开“扫一扫”，选择从相册选取二维码方式。</p>
            <p>3. 识别云服务公众号后，点击关注开启体验官之旅！</p>
        </div>
        <div class="intro">
            <p>Tips: 公众号内测中，仅支持扫描二维码关注。</p>
        </div>
        <div class="intro intro2">
            <h3>客服热线</h3>
            <p>如有疑问，请联系客服：400-830-3666转2号</p>
        </div>
    </div>

    <!-- 第四屏-->
    <div class="w80 mat mt10 dpn" id="frame4">
        <div class="w70 mat mb10"><img src="resources/images/over.png" class=""> </div>
        <p class="title" style="color: #000; font-weight: bold;">活动已结束</p>
        <div class="hint">其他车型陆续开放中，敬请期待！</div>
    </div>

    <!--<canvas width="378" height="378" id="mycanvas" style="position: absolute; top: 0; left: 0; z-index: 100;"></canvas>-->
</body>
</html>
<script>
    var endDate = new Date('2018-09-06').getTime();
    var nowDate = new Date().getTime();
    if(nowDate>endDate){
        $("#frame1").hide();
        $("#frame4").show();
    }
    var ajaxUrl = '';
    var errCode = {
        "40001":"网络繁忙，请稍候再试",
        "40002":"本期仅支持云服务宋车主参加哦",
        "40003":"您已经是体验官了",
        "40004":"请输入短信验证码",
        "40005":"验证码错误，请重试",
        "40006":"操作太频繁啦，请明天再试",
        "40007":"活动已结束"
    };
    //生成图形验证码
    var verifyCode = new GVerify("imgCode");
    var verifyCode1 = new GVerify("imgCode1");
    var verifyCode2 = new GVerify("imgCode2");
    var btnDisabled = false;
    //点击提交
    $("#btn1").on('click',function(){
        if(btnDisabled) return;
        var phone = $("#phone").val().replace(/\s/g, "");
        if(phone == ''){
            warn('请输入手机号');
            return;
        }
        if(!(/^1[3456789]\d{9}$/.test(phone))){
            warn('手机号格式不正确');
            return;
        }
        var imgCode = $("#imgCodeVal").val().replace(/\s/g, "");
        if(imgCode == ''){
            warn('请输入验证码');
            return;
        }
        var check = verifyCode.validate(document.getElementById("imgCodeVal").value);
        if(check){
            console.log('验证码正确');
        }else{
            warn('验证码错误，请重试');
            return;
        }
        btnDisabled = true;
        $.ajax({
            type:'POST',
            url:ajaxUrl+"/wechatprivilege/check",
            contentType: 'application/json',
            data:JSON.stringify({
                "reqPhone": phone
            }),
            success:function(res){
                btnDisabled = false;
                var data = JSON.parse(res);
                if(data.rebackResult == 0){
                    var phoneChange = phone.substr(0,3)+" "+phone.substr(3,4)+" "+phone.substr(7,4);
                    $("#phone2").html(phoneChange);
                    $("#frame1").hide();
                    $("#frame2").show();
                    $("#banner1").hide();
                    $("#banner2").show();
                    getMsgCode();
                    $("#codeInput").select();
                    $("#codeInput").focus();
                    $("#codeInput").click();
                }else{
                    warn(errCode[data.rebackDesc]);
                    verifyCode.refresh();
                    if(data.rebackDesc == '40003'){
                        $("#frame1").hide();
                        $("#frame3").show();
                        $("#banner1").hide();
                        $("#banner2").show();
                    }else if(data.rebackDesc == '40007'){
                        $("#frame1").hide();
                        $("#frame4").show();
                    }
                }
            },
            error:function(){
                btnDisabled = false;
            }
        });
    });

    $("#codeList").on('click',function(){
        $("#codeInput").select();
        $("#codeInput").focus();
        $("#codeInput").click();
    });
    //输入短信验证码
    $("#codeInput").on('input',function(){
        $("#codeList li").html('');
        var valArr = $(this).val().split("");
        for(var i=0;i<valArr.length;i++){
            $("#codeList li").eq(i).html(valArr[i]);
        }
    });

    //错误提示
    function warn(txt){
        $("#warn span").html(txt);
        $("#warn").css({
            'opacity':'1'
        });
        setTimeout(function(){
            $("#warn").css('opacity','0');
        },3000)
    }

    //获取验证码
    let time = 0,t;
    function getMsgCode(){
        time = 60;
        countTime();
        t = setInterval(countTime,1000);
        $.ajax({
            type:'POST',
            url:ajaxUrl+"/wechatprivilege/getLoginWarrant",
            contentType: 'application/json',
            data:JSON.stringify({
                reqPhone:$("#phone").val()
            }),
            success:function(res){
                var data = JSON.parse(res);
                if(data.rebackResult == 0){
//                    countTime();
//                    t = setInterval(countTime,1000);
                }else{
                    warn(errCode[data.rebackDesc]);
                    if(data.rebackDesc == '40007'){
                        $("#frame1").hide();
                        $("#frame2").hide();
                        $("#frame4").show();
                    }else if(data.rebackDesc == '40006'){
                        $("#frame2").hide();
                        $("#frame1").show();
                    }
                }
            },
            error:function(){
                btnDisabled = false;
            }
        });
    }
    //倒计时
    function countTime(){
        if(time == 0){
            clearInterval(t);
            $("#count span").html("再次获取验证码");
        }else{
            time --;
            $("#count span").html(time+"s后获取");
        }
    }
    //点击获取验证码
    $("#count").on('click',function(){
        if(time == 0){
            getMsgCode();
        }
    });
    //点击完成
    $("#btn2").on('click',function(){
        if(btnDisabled) return;
        var code = $("#codeInput").val().replace(/\s/g, "");
        if(code == ''){
            warn('请输入验证码');
            return;
        }
        btnDisabled = true;
        $.ajax({
            type:'POST',
            url:ajaxUrl+"/wechatprivilege/addWxTyy",
            contentType: 'application/json',
            data:JSON.stringify({
                reqPhone:$("#phone").val().replace(/\s/g, ""),
                verifyData:md5(code).toUpperCase()
            }),
            success:function(res){
                btnDisabled = false;
                var data = JSON.parse(res);
                if(data.rebackResult == 0){
                    warn('恭喜您抢到了体验官名额！');
                    $("#frame2").hide();
                    $("#frame3").show();
                }else{
                    warn(errCode[data.rebackDesc]);
                    if(data.rebackDesc == '40007'){
                        $("#frame1").hide();
                        $("#frame2").hide();
                        $("#frame4").show();
                    }else if(data.rebackDesc == '40006'){
                        $("#frame2").hide();
                        $("#frame1").show();
                    }
                }
            },
            error:function(){
                btnDisabled = false;
            }
        });
    });

    window.addEventListener("resize", function () {
        if (document.activeElement.tagName == "INPUT" || document.activeElement.tagName == "TEXTAREA") {
            window.setTimeout(function () {
                document.activeElement.scrollIntoViewIfNeeded();
            }, 0);
        }
    });
</script>