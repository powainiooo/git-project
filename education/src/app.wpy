<style lang="less">
   @import "res/helvetica.wxss";
   page { background-color: #edecea}
   .text-shadow { text-shadow: 0 0 3px rgba(54, 42, 26, 0.33);}
   .container { width: 100%; padding-bottom: 300rpx; transition: all 0.15s ease-out;}

   .shadow1 { position: relative;}
   .shadow1::after { content: ''; width: 100%; height: 40rpx; background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAAnCAYAAAAl15mhAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFIGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDUgNzkuMTYzNDk5LCAyMDE4LzA4LzEzLTE2OjQwOjIyICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOSAoTWFjaW50b3NoKSIgeG1wOkNyZWF0ZURhdGU9IjIwMjAtMDMtMTJUMTU6MzU6MDYrMDg6MDAiIHhtcDpNb2RpZnlEYXRlPSIyMDIwLTAzLTEyVDE1OjM2OjE2KzA4OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDIwLTAzLTEyVDE1OjM2OjE2KzA4OjAwIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIgcGhvdG9zaG9wOklDQ1Byb2ZpbGU9InNSR0IgSUVDNjE5NjYtMi4xIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjgxZWE0OGY5LWE2Y2YtNDVhNS05NDI4LTJlNDQ5NmRlZWYwYyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo4MWVhNDhmOS1hNmNmLTQ1YTUtOTQyOC0yZTQ0OTZkZWVmMGMiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo4MWVhNDhmOS1hNmNmLTQ1YTUtOTQyOC0yZTQ0OTZkZWVmMGMiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjcmVhdGVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjgxZWE0OGY5LWE2Y2YtNDVhNS05NDI4LTJlNDQ5NmRlZWYwYyIgc3RFdnQ6d2hlbj0iMjAyMC0wMy0xMlQxNTozNTowNiswODowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKE1hY2ludG9zaCkiLz4gPC9yZGY6U2VxPiA8L3htcE1NOkhpc3Rvcnk+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8++qelhQAAAClJREFUGJVjNNOS4WNgYGBgYoACFgYGhr+4Gf8JMBj////PgGLgSGYAAFZ0CtVq9vBKAAAAAElFTkSuQmCC) repeat-x; background-size: auto 100%; position: absolute; top: 100%; left: 0;}
   .hscale { transform: scale(0.95);}
   .title1 { font-size: 40rpx; color: #ffffff;}
   .title1 .en { font-weight: bold}
   .title2 { font-size: 40rpx; color: #221715;}
   .title2 .en { font-weight: bold}
   .hint { margin: 40rpx 60rpx;  font-size: 25rpx; color: #b9babb; line-height: 1.7}
   .blur { filter: blur(2px); -webkit-filter: blur(2px);}

   .footer { width: 100%; position: fixed; bottom: 40rpx; left: 0; display: flex; justify-content: center;}
   .footer .button { width: 540rpx; height: 170rpx; border-radius: 30rpx; background-color: #e5ad84; display: flex; justify-content: center; align-items: center; box-shadow: 0 20rpx 15rpx rgba(0, 0, 0, 0.12); font-size: 40rpx; color: #ffffff; text-shadow: 0 0 3px rgba(54, 42, 26, 0.33); transition: all 0.15s ease-out; border: none;}

   .student-item { height: 170rpx; margin: 0 40rpx 40rpx 40rpx; display: flex; align-items: center; justify-content: space-between; padding: 0 30rpx; background-color: #ffffff; border-radius: 30rpx; box-shadow: 0 20rpx 15rpx rgba(0, 0, 0, 0.15); transition: transform 0.1s linear;}
   .student-item .avatar { width: 140rpx; height: 140rpx; display: block; border-radius: 50%; box-shadow: 0 0 2px rgba(0, 0, 0, 0.28);}
   .student-item .name { color: #221715; font-size: 35rpx;}

   .lesson-item { margin: 0 40rpx 40rpx 40rpx; display: flex; align-items: center; justify-content: center; background-color: #e5ad84; border-radius: 30rpx; box-shadow: 0 20rpx 15rpx rgba(0, 0, 0, 0.12); position: relative; overflow: hidden; transition: transform 0.1s linear;}
   .lesson-item .img { width: 100%; display: block;}
   .lesson-item .name { font-size: 40rpx; color: #ffffff; position: absolute; left: 25rpx; bottom: 50rpx;}
   .lesson-item-student::before { content: ''; width: 1prx; height: 100%; border-left: 1px dashed #d0a583; position: absolute; right: 70rpx; top: 0; z-index: 5}
   .lesson-item-student::after { content: ''; width: 1prx; height: 100%; border-left: 1px dashed #e8d3c2; position: absolute; right: 70rpx; top: 0; z-index: 5}
   .lesson-item .use-over { width: 70rpx; height: 100%; position: absolute; top: 0; right: 0; background-color: #7e9eab;}
   .lesson-item .use-over::after { content: '已用完'; width: 100rpx; font-size: 30rpx; color: #ffffff; position: absolute; top: 170rpx; right: -14rpx; transform: rotateZ(90deg);}
   .lesson-item .nums { width: 134rpx; height: 134rpx; box-sizing: border-box; position: absolute; top: -4rpx; left: -4rpx; background-color: #ffffff; border-radius: 0 0 130rpx 0; text-align: center; color: #221715; font-size: 40rpx; padding-top: 24rpx; font-weight: bold; font-family: Arial}
   .lesson-item .nums .unit { color: #b9babc; font-size: 25rpx; font-weight: normal;}

   .buy-item { height: 174rpx; border-radius: 30rpx; background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVUAAACuCAMAAACx8G5yAAAAM1BMVEUAAADpuZDpuZDpuZDpuZDpuZDpuZDpuZDpuZDpuZDpuZDpuZDpuZDpuZDpuZDpuZDpuZC73H2XAAAAEHRSTlMAgMBAEPDgMKBg0CBQsJBwbvKTPQAAAqJJREFUeNrt2llu1kAQReHbg+ep9r9afhASkBAe4ltSLM63hKNWdbllvdWWgps2/a4vR+C+pl/6PATMVQtN7VV7DbirThxUo0bUiKSqG1H9VfsasFc9A1Zd0hTw0gs7VULVLWDGVM0gaQyYcVclqNIVMKuM1QSVvSqCqo9QqBpB1UegaoadqgkaVSOo+gi8A75Q9QlGqiaoVI2g6iMUqkZQ9REaVSOo+gj8DfBC1SeoVE1wUDVBoWqChaoJGlUTiKp+I1UTVKomKFRNsFA1QaNqAlHVb6VqgpmqCS6qJmhUTSCq+q1UTTBTNcFF1QQTVROIqn6VqgkKVRM0qiYQVf1WqiY4qZpgp2qCTlW/Kqr6FaomaFT1G0RVv4OqCRaqJtio6reKqn4nVRNMVPUbRVW/maoJdqr6DaKq30zVBDtV/QZR1W+maoKdqn6DqOo3UzXBRFW/UVT1K1RNsFHVr4qqfgtV/YZOVb9ZVPWbqOq3iqp+C1X9hk5Vv1lU9duo6ldFVb+dqn6jqOp3UdVv6FT1O0VVv42qfrOo6rdR1e8QVf0aVf2qqOrXqOpXRVW/RlW/Kqr6Nar6VVHVr1HVr4qqfhtV/WZR1W+jql8RVe2GTlW/S1S1G0VVv0ZVvyqq+m1U9Suiqt3Yqeq3i6p2VVT126jqV0RVu1FU9WtU9TtFVbuxU9VvF1XtDlHVbuhU9dtFVbtZVLUbO1X9mqhqd4qqdquoajdMVPVbRFW7Q1S1GztV/SZR1e7SZxwB81B9KYGPrV2fsgcMm+obPfDvTZXB6nXq05bA31XdMAY+Wv85rBFf46b6aQ28t+ueKfBO0V1X4I1Z982BP6wSWX/4Ah+qPAcYr/+PNdZWf1SplyHw3SKnXjivL4vcpnL8798ERfd9A7oYafqu+FkaAAAAAElFTkSuQmCC) no-repeat; background-size: auto 100%; background-color: #ffffff; display: flex; justify-content: space-between; transition: transform 0.1s linear; margin-bottom: 30rpx; box-shadow: 0 20rpx 15rpx rgba(0, 0, 0, 0.12);}
   .buy-item .lesson { width: 300rpx; display: flex; justify-content: center; align-items: baseline; font-size: 60rpx; color: #ffffff; padding-top: 46rpx; font-weight: bold;}
   .buy-item .lesson .unit { font-size: 25rpx; font-weight: normal;}
   .buy-item .price { margin-right: 30rpx; font-size: 50rpx; color: #221715; text-align: right; padding-top: 40rpx;}
   .buy-item .price .line1 { font-weight: bold;}
   .buy-item .price .unit { font-size: 25rpx; color: #b9babb; font-weight: normal;}
</style>

<script>
   import wepy from '@wepy/core'
   import eventHub from './common/eventHub'
   import vuex from '@wepy/x'
   import store from './store'
   import {promisify} from '@/res/util.js'
   import {doLogin} from '@/res/api.js'
   const login = promisify(wx.login)
   const getSetting = promisify(wx.getSetting)
   const getUserInfo = promisify(wx.getUserInfo)

   wepy.use(vuex)

   wepy.app({
      hooks: {
         // App 级别 hook，对整个 App 生效
         // 同时存在 Page hook 和 App hook 时，优先执行 Page hook，返回值再交由 App hook 处
         'before-setData': function (dirty) {
            // console.log('setData dirty: ', dirty)
            return dirty
         }
      },
      globalData: {
         userInfo: null,
         code: null
      },

      onLaunch() {
         eventHub.$on('app-launch', (...args) => {
            console.log('app-launch event emitted, the params are:')
            console.log(args)
         })
         this.onlogin()
      },

      methods: {
         async onlogin () {
            let lastGetCityTime = wx.getStorageSync('lastGetCityTime')
            if (lastGetCityTime === '' || lastGetCityTime === null) {
               lastGetCityTime = 0
            }
            const now = new Date().getTime()
            const userInfo = wx.getStorageSync('bbaUserInfo')
            if (userInfo === '' || userInfo === null || now > lastGetCityTime + 24 * 60 * 60 * 1000) {
               const resLogin = await login()
               console.log('resLogin', resLogin)
               this.$options.globalData.code = resLogin.code
               const resSetting = await getSetting()
               console.log('resSetting', resSetting)
               if (resSetting.authSetting['scope.userInfo']) {
                  const resUserInfo = await getUserInfo()
                  doLogin({
                     code: resLogin.code,
                     rawData: resUserInfo.rawData
                  }).then(res => {
                     this.$options.globalData.userInfo = res.data.userInfo
                     store.commit('setPersonInfo', res.data.userInfo)
                     wx.setStorageSync('lastGetCityTime', now)
                     wx.setStorageSync('bbaUserInfo', res.data.userInfo)
                  })
               } else {
                  console.log('resSetting not')
                  wx.redirectTo({
                     url: '/pages/index?type=auth'
                  })
               }
            } else {
               this.$options.globalData.userInfo = userInfo
               store.commit('setPersonInfo', userInfo)
            }
         }
      }
   })
</script>
<config>
   {
   "pages": [
      "pages/index",
      "pages/comment",
      "pages/lessonDetail",
      "pages/lesson",
      "pages/store",
      "pages/order",
      "pages/studentlesson",
      "pages/password",
      "pages/result",
      "pages/newfile",
      "pages/lessonBuy",
      "pages/student",
      "pages/orderConfirm",
      "pages/welcome"
   ],
   "window": {
   "backgroundTextStyle": "light",
   "navigationBarBackgroundColor": "#e5ad84",
   "navigationBarTitleText": "",
   "navigationBarTextStyle": "black",
   "backgroundColor": "#edeceb"
   },
   "usingComponents": {
      "menu": "~@/components/menu",
      "zHeader": "~@/components/zHeader.wpy"
      }
   }
</config>
